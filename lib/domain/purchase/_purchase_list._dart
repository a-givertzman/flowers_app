import 'dart:async';

import 'package:flowers_app/domain/purchase/purchase.dart';
import 'package:flowers_app/infrastructure/api/api_params.dart';
import 'package:flowers_app/infrastructure/datasource/data_set.dart';
import 'package:flowers_app/infrastructure/datasource/data_source.dart';

class PurchaseList {
  final DataSet remote;
  ApiParams? _params;
  final _streamController = StreamController<List<dynamic>>();

  Stream<List<dynamic>> get dataStream {
    _streamController.onListen = refresh;
    return  _streamController.stream;
  }

  PurchaseList({
    required id,
    required this.remote,
  });

  Future refresh() async {
    _dispatch(_params);
  }

  void _dispatch(params) async {
    print('[PurchaseList._dispatch]');
    _params = params;
    _streamController.sink.add(List.empty());
    remote.fetch(params: params)
      .then(
        (sqlMap) {
          List<dynamic> purchaseList = [];
            for (var i = 0; i < sqlMap.length; i++) {
            final row = sqlMap[i];
            purchaseList.add(
              Purchase(id: row['id']).fromRow(row)
            );
          }
          _streamController.sink.add(purchaseList);
        }
      )
      .catchError((e) {
        print('[PurchaseList.handleError]');
        print(e);
        _streamController.addError(e);
      });
  }
}